# automation-extra-plugin [![Build Status](https://travis-ci.org/berstend/puppeteer-extra.svg?branch=master)](https://travis-ci.org/berstend/puppeteer-extra) [![npm](https://img.shields.io/npm/v/automation-extra-plugin.svg)](https://www.npmjs.com/package/automation-extra-plugin)

## Installation

```bash
yarn add automation-extra-plugin
```

## WIP

New base plugin to support both Playwright and Puppeteer.

**UNDER ACTIVE DEVELOPMENT - NOT MEANT TO BE USED YET**

## Differences

Successor to `puppeteer-extra-plugin`

- Simpler API surface
- Ships with `this.env` which gives info about the current environment and provides type guards
- New Playwright specific events (`beforeContext`, `onContextCreated`, `onContextClose`)
- Removed crusty "data from plugins" logic
- Plugins don't register their own event listeners anymore (`_bindBrowserEvents` is gone), everything is called from the mother ship (`automation-extra`)
- Supports requiring dependencies with a specific config
- Much improved type safety
- TODO: A shim and utility functions will make writing agnostic plugins easier

## API

<!--
    Documentation is auto-generated by a custom fork of documentation.js
    More info: https://github.com/berstend/documentation-markdown-themes/wiki#documentationjs-with-markdown-theme-support
    Update this documentation by updating the source code.
-->

#### Table of Contents

- [class: PluginLifecycleMethods](#class-pluginlifecyclemethods)
  - [.onPluginRegistered()](#onpluginregistered)
  - [.beforeLaunch(options)](#beforelaunchoptions)
  - [.afterLaunch(browser, launchContext)](#afterlaunchbrowser-launchcontext)
  - [.beforeConnect(options)](#beforeconnectoptions)
  - [.afterConnect(browser, launchContext)](#afterconnectbrowser-launchcontext)
  - [.onBrowser(browser, launchContext)](#onbrowserbrowser-launchcontext)
  - [.beforeContext(options, browser)](#beforecontextoptions-browser)
  - [.onContextCreated(context, options)](#oncontextcreatedcontext-options)
  - [.onPageCreated(page)](#onpagecreatedpage)
  - [.onPageClose(page)](#onpageclosepage)
  - [.onContextClose(context)](#oncontextclosecontext)
  - [.onDisconnected(browser)](#ondisconnectedbrowser)
- [class: AutomationExtraPlugin](#class-automationextraplugin)
  - [.env](#env)
  - [.shim(page)](#shimpage)
  - [.defaults](#defaults)
  - [.requirements](#requirements)
  - [.dependencies](#dependencies)
  - [.opts](#opts)
  - [.debug](#debug)
  - [.id](#id)
- [class: TypeGuards](#class-typeguards)
  - [.isPage(obj)](#ispageobj)
  - [.isBrowser(obj)](#isbrowserobj)
  - [.isPuppeteerPage(obj)](#ispuppeteerpageobj)
  - [.isPuppeteerBrowser(obj)](#ispuppeteerbrowserobj)
  - [.isPuppeteerBrowserContext(obj)](#ispuppeteerbrowsercontextobj)
  - [.isPlaywrightPage(obj)](#isplaywrightpageobj)
  - [.isPlaywrightBrowser(obj)](#isplaywrightbrowserobj)
  - [.isPlaywrightBrowserContext(obj)](#isplaywrightbrowsercontextobj)
- [class: LauncherEnv](#class-launcherenv)
  - [.browserName](#browsername)
  - [.driverName](#drivername)
- [class: PageShim](#class-pageshim)
  - [.addScript(script, arg?)](#addscriptscript-arg)

### class: [PluginLifecycleMethods](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L40-L206)

Plugin lifecycle methods

---

#### .[onPluginRegistered()](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L44-L44)

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;void>**

After the plugin has been registered, called early in the life-cycle (once the plugin has been added).

---

#### .[beforeLaunch(options)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L62-L62)

- `options` **LaunchOptions** Puppeteer/Playwright launch options

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;(LaunchOptions | void)>**

Before a new browser instance is created/launched.

Can be used to modify the puppeteer/playwright launch options by modifying or returning them.

Plugins using this method will be called in sequence to each
be able to update the launch options.

Example:

```javascript
async beforeLaunch (options) {
  if (this.opts.flashPluginPath) {
    options.args.push(`--ppapi-flash-path=${this.opts.flashPluginPath}`)
  }
}
```

---

#### .[afterLaunch(browser, launchContext)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L90-L90)

- `browser` **Browser** The `puppeteer` or `playwright` browser instance.
- `launchContext` **LaunchContext**

After the browser has launched.

Note: Don't assume that there will only be a single browser instance during the lifecycle of a plugin.
It's possible that `pupeeteer.launch` will be called multiple times and more than one browser created.
In order to make the plugins as stateless as possible don't store a reference to the browser instance
in the plugin but rather consider alternatives.

E.g. when using `onPageCreated` you can get a browser reference by using `page.browser()`.

Alternatively you could expose a class method that takes a browser instance as a parameter to work with:

```es6
const fancyPlugin = require('puppeteer-extra-plugin-fancy')()
puppeteer.use(fancyPlugin)
const browser = await puppeteer.launch()
await fancyPlugin.killBrowser(browser)
```

Example:

```javascript
async afterLaunch (browser, opts) {
  this.debug('browser has been launched', opts.options)
}
```

---

#### .[beforeConnect(options)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L102-L104)

- `options` **ConnectOptions** Puppeteer/playwright connect options

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;(ConnectOptions | void)>**

Before connecting to an existing browser instance.

Can be used to modify the puppeteer/playwright connect options by modifying or returning them.

Plugins using this method will be called in sequence to each
be able to update the launch options.

---

#### .[afterConnect(browser, launchContext)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L114-L114)

- `browser` **Browser** The `puppeteer` or playwright browser instance.
- `launchContext` **LaunchContext**

After connecting to an existing browser instance.

> Note: Don't assume that there will only be a single browser instance during the lifecycle of a plugin.

---

#### .[onBrowser(browser, launchContext)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L128-L128)

- `browser` **Browser** The `puppeteer` or `playwright` browser instance.
- `launchContext` **LaunchContext**

Called when a browser instance is available.

This applies to both `launch` and `connect`.

Convenience method created for plugins that need access to a browser instance
and don't mind if it has been created through `launch` or `connect`.

> Note: Don't assume that there will only be a single browser instance during the lifecycle of a plugin.

---

#### .[beforeContext(options, browser)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L143-L146)

- `options` **Playwright.BrowserContextOptions** Playwright browser context options
- `browser` **Playwright.Browser** Playwright browser

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;(Playwright.BrowserContextOptions | void)>**

Before a new browser context is created.

Note: Currently only triggered by `playwright`, as puppeteer's usage of context is very lackluster.

Plugins using this method will be called in sequence to each
be able to update the context options.

- **See: <https://github.com/microsoft/playwright/blob/master/docs/api.md#browsernewcontextoptions>**

---

#### .[onContextCreated(context, options)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L156-L159)

- `context` **Playwright.BrowserContext** Playwright browser context
- `options` **Playwright.BrowserContextOptions** Playwright browser context options

After a new browser context has been created.

Note: `playwright` specific.

---

#### .[onPageCreated(page)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L180-L180)

- `page` **(Puppeteer.Page | Playwright.Page)**

Called when a page has been created.

The event will also fire for popup pages.

Example:

```javascript
async onPageCreated (page) {
  let ua = await page.browser().userAgent()
  if (this.opts.stripHeadless) {
    ua = ua.replace('HeadlessChrome/', 'Chrome/')
  }
  this.debug('new ua', ua)
  await page.setUserAgent(ua)
}
```

- **See: <https://playwright.dev/#version=v1.3.0&path=docs%2Fapi.md&q=event-page>**
- **See: <https://pptr.dev/#?product=Puppeteer&version=main&show=api-event-targetcreated>**

---

#### .[onPageClose(page)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L186-L186)

- `page` **Page**

Called when a page has been closed.

---

#### .[onContextClose(context)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L194-L194)

- `context` **Playwright.BrowserContext**

Called when a browser context has been closed.

Note: `playwright` specific.

---

#### .[onDisconnected(browser)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L205-L205)

- `browser` **Browser** The `puppeteer` or `playwright` browser instance.

Called when the browser got disconnected.

This might happen because of one of the following:

- The browser is closed or crashed
- The `browser.disconnect` method was called

---

### class: [AutomationExtraPlugin](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L228-L412)

**Extends: PluginLifecycleMethods**

AutomationExtraPlugin - Meant to be used as a base class and it's methods overridden.

Implements all `PluginLifecycleMethods`.

Example:

```javascript
class Plugin extends AutomationExtraPlugin {
  static id = 'foobar'
  constructor(opts = {}) {
    super(opts)
  }

  async beforeLaunch(options) {
    options.headless = false
    return options
  }
}
```

---

#### .[env](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L256-L256)

Type: **[LauncherEnv](#launcherenv)**

Contains info regarding the launcher environment the plugin runs in

- **See: LauncherEnv**

---

#### .[shim(page)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L288-L288)

- `page` **Page**

Returns: **[PageShim](#pageshim)**

Unified Page methods for Playwright & Puppeteer

---

#### .[defaults](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L317-L319)

Type: **PluginOptions**

Plugin defaults (optional).

If defined will be ([deep-](https://github.com/TehShrike/deepmerge))merged with the (optional) user supplied options (supplied during plugin instantiation).

The result of merging defaults with user supplied options can be accessed through `this.opts`.

Example:

```javascript
get defaults () {
  return {
    stripHeadless: true,
    makeWindows: true,
    customFn: null
  }
}

// Users can overwrite plugin defaults during instantiation:
puppeteer.use(require('puppeteer-extra-plugin-foobar')({ makeWindows: false }))
```

- **See: \[[opts]]**

---

#### .[requirements](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L342-L344)

Type: **PluginRequirements**

Plugin requirements (optional).

Signal certain plugin requirements to the base class and the user.

Currently supported:

- `launch`
  - If the plugin only supports locally created browser instances (no `puppeteer.connect()`),
    will output a warning to the user.
- `headful`
  - If the plugin doesn't work in `headless: true` mode,
    will output a warning to the user.
- `runLast`
  - In case the plugin prefers to run after the others.
    Useful when the plugin needs data from others.

Example:

```javascript
get requirements () {
  return new Set(['runLast', 'dataFromPlugins'])
}
```

---

#### .[dependencies](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L363-L365)

Type: **PluginDependencies**

Plugin dependencies (optional).

Missing plugins will be required() by automation-extra.

Example:

```javascript
// Will ensure the 'puppeteer-extra-plugin-user-preferences' plugin is loaded.
get dependencies () {
  return new Set(['user-preferences'])
}

// Will load `user-preferences` plugin and pass `{ beCool: true }` as opts
get dependencies () {
  return new Map([['user-preferences', { beCool: true }]])
}
```

---

#### .[opts](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L382-L384)

Type: **PluginOptions**

Access the plugin options (usually the `defaults` merged with user defined options)

To skip the auto-merging of defaults with user supplied opts don't define a `defaults`
property and set the `this._opts` Object in your plugin constructor directly.

Example:

```javascript
get defaults () { return { foo: "bar" } }

async onPageCreated (page) {
  this.debug(this.opts.foo) // => bar
}
```

- **See: \[[defaults]]**

---

#### .[debug](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L402-L404)

Type: **Debugger**

Convenience debug logger based on the [debug] module.
Will automatically namespace the logging output to the plugin package name.

[debug]: https://www.npmjs.com/package/debug

```bash
# toggle output using environment variables
DEBUG=automation-extra-plugin:<plugin_id> node foo.js
# to debug all the things:
DEBUG=automation-extra,automation-extra-plugin:* node foo.js
```

Example:

```javascript
this.debug('hello world')
// will output e.g. 'automation-extra-plugin:anonymize-ua hello world'
```

---

#### .[id](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L250-L250)

Plugin id/name (required)

Convention:

- Package: `automation-extra-plugin-anonymize-ua`
- Name: `anonymize-ua`

Example:

```javascript
static id = 'anonymize-ua';
// or
static get id() {
  return 'anonymize-ua'
}
```

---

### class: [TypeGuards](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L423-L490)

TypeGuards

---

#### .[isPage(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L431-L433)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isBrowser(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L439-L441)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPuppeteerPage(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L447-L449)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPuppeteerBrowser(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L455-L457)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPuppeteerBrowserContext(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L463-L465)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPlaywrightPage(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L471-L473)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPlaywrightBrowser(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L479-L481)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPlaywrightBrowserContext(obj)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L487-L489)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

### class: [LauncherEnv](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L498-L540)

**Extends: TypeGuards**

Store environment specific info and make lookups easy

---

#### .[browserName](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L506-L506)

The name of the browser engine currently in use: `"chromium" | "firefox" | "webkit"`.
Note: The browser will only be known once a browser object is available.

---

#### .[driverName](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L511-L511)

The name of the driver currently in use: `"playwright" | "puppeteer"`.

---

### class: [PageShim](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L553-L583)

Unified Page methods for Playwright & Puppeteer

---

#### .[addScript(script, arg?)](https://github.com/berstend/puppeteer-extra/blob/d0cc14e305b5eddd3a6e551e25666ee8eb8b2500/packages/automation-extra-plugin/src/index.ts#L574-L582)

- `script` **([string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String) \| [Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function))**
- `arg` **Serializable?**

Adds a script which would be evaluated in one of the following scenarios:

Whenever the page is navigated.
Whenever the child frame is attached or navigated. In this case, the script is evaluated in the context of the newly attached frame.

The script is evaluated after the document was created but before any of its scripts were run.

- **See: **Playwright:** `addInitScript`
  **Puppeteer:** `evaluateOnNewDocument`**

---
